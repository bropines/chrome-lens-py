# Chrome Lens API для Python

[English](/README.md) | [Русский](/README_RU.md)

Этот проект предоставляет библиотеку Python и CLI инструмент для взаимодействия с функциональностью OCR Google Lens через API, используемое в Chromium. Это позволяет обрабатывать изображения и извлекать текстовые данные, включая полный текст, координаты и сшитый текст, используя различные методы.

## Возможности

- **Извлечение полного текста**: Извлекайте полный текст с изображения.
- **Извлечение координат**: Извлекайте текст вместе с его координатами.
- **Сшитый текст**: Восстанавливайте текст из блоков координат, используя различные методы:
  - **Умный метод**: Улучшенное построчное сшивание текста, подходит для большинства изображений (но может быть менее эффективен для сильно повернутого текста).
  - **Последовательный метод**: Базовое последовательное сшивание текстовых блоков.
- **Ввод из различных источников**: Обрабатывайте изображения из файловых путей, URL-адресов, объектов [PIL Image](https://pillow.readthedocs.io/en/stable/reference/Image.html) и массивов [NumPy](https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html) (включая изображения, считанные с помощью [OpenCV](https://opencv.org/)).
- **Сканирование изображений по URL**: Обрабатывайте изображения напрямую по URL без необходимости предварительно их загружать.
- **Управление куки**: Загружайте и управляйте куки из файла в формате Netscape или напрямую через конфигурацию.
- **Поддержка прокси**: Поддержка HTTP, HTTPS и SOCKS4/5 прокси для выполнения запросов через разные сети.
- **Ограничение скорости (Rate Limiting)**: Контролируйте количество запросов в минуту для соблюдения ограничений использования API.
- ~~**Выбор типа заголовков**: Выбирайте между различными наборами заголовков запросов (`default`, `custom`, `chrome`).~~ Временно убрано!

**Важно: Асинхронный API**

**Эта библиотека теперь использует асинхронные запросы для повышения производительности и эффективности. При использовании программного API необходимо использовать `async` и `await` в вашем коде для вызова методов API. Смотрите раздел "Использование API" для примеров.**

_PS: У Google Lens есть проблема с отображением полного текста, поэтому добавлены методы, которые сшивают текст из координат._

## Установка

Вы можете установить пакет, используя `pip`:

### Из PyPI

```bash
pip install chrome-lens-py
```

### Обновление через PyPI

```bash
pip install -U chrome-lens-py
```

### Из GIT

```bash
pip install git+https://github.com/bropines/chrome-lens-py.git
```

### Из исходников

Клонируйте репозиторий и установите пакет:

```bash
git clone https://github.com/bropines/chrome-lens-api-py.git
cd chrome-lens-api-py
pip install -r requirements.txt
pip install .
```

## Использование

Вы можете использовать команду `lens_scan` в CLI для обработки изображений и извлечения текстовых данных, или вы можете использовать Python API для интеграции этой функциональности в ваши собственные проекты.

<details>
  <summary><b>Использование CLI</b></summary>

```bash
lens_scan <image_source> <data_type> [опции]
```

- `<image_source>`: Путь к файлу изображения или URL, или путь к каталогу для пакетной обработки.
- `<data_type>`: Тип данных для извлечения (см. ниже).
- `[опции]`: Дополнительные флаги для настройки поведения.

#### Типы данных

- **all**: Получить все данные (полный текст, координаты и сшитый текст с использованием умного и последовательного методов).
- **full_text_default**: Получить только полный текст по умолчанию.
- **full_text_sequential**: Получить сшитый текст с использованием последовательного метода.
- **full_text_smart**: Получить сшитый текст с использованием умного метода.
- **coordinates**: Получить текст вместе с координатами.

#### Опции

- **`-h, --help`**: Показать это справочное сообщение и выйти.
- **`-c, --cookie-file <путь>`**: Путь к файлу cookie в формате Netscape.
- **`-p, --proxy <URL_прокси>`**: Указать прокси-сервер (например, `socks5://user:pass@host:port`).
- **`--config-file <путь>`**: Путь к файлу конфигурации.
- **`--debug=(info|debug)`**: Включить логирование на указанном уровне (`info` или `debug`).
- **`--coordinate-format=(percent|pixels)`**: Формат вывода координат: `'percent'` или `'pixels'`.
- **`-st, --sleep-time <миллисекунды>`**: Время задержки между запросами в миллисекундах (для пакетной обработки).
- **`-uc, --update-config`**: Обновить файл конфигурации по умолчанию аргументами CLI (исключая прокси и cookies).
- **`--debug-out <путь>`**: Путь для сохранения отладочного вывода ответа (при использовании `--debug=debug`).
- **`--out-txt=(per_file|имя_файла.txt)`**: Опция вывода для пакетной обработки: `'per_file'` для вывода каждого результата в отдельный текстовый файл, или указать `имя_файла.txt` для общего файла вывода.
- ~~**`--header-type=(default|custom|chrome)`**: Тип заголовков для использования: `'default'`, `'custom'` или `'chrome'`.~~ Временно убрано!
- **`--rate-limit-rpm <RPM>`**: Установить максимальное количество запросов в минуту (RPM), значение от 1 до 50.

#### Примеры

Извлечение текста с использованием умного метода сшивания из локального файла:

```bash
lens_scan путь/к/изображению.jpg full_text_smart
```

Извлечение текста с использованием умного метода сшивания по URL:

```bash
lens_scan https://example.com/image.jpg full_text_smart
```

Получение всех доступных данных из локального файла и вывод координат в пикселях:

```bash
lens_scan путь/к/изображению.jpg all --coordinate-format=pixels
```

Обработка всех изображений в каталоге и сохранение результатов в отдельные файлы:

```bash
lens_scan /путь/к/изображениям all --out-txt=per_file
```

Установка ограничения скорости в 30 запросов в минуту:

```bash
lens_scan путь/к/изображению.jpg all --rate-limit-rpm 30
```

~~Использование Chrome-подобных заголовков для запросов:~~ Временно убрано!

```bash
lens_scan путь/к/изображению.jpg all --header-type chrome
```


#### CLI Справка

Вы можете использовать опцию `-h` или `--help`, чтобы вывести справочную информацию:

```bash
lens_scan -h
```

</details>

<details>
  <summary><b>Использование API</b></summary>

В дополнение к CLI инструменту, этот проект предоставляет Python API, который можно использовать в ваших скриптах.

**Важно: Асинхронный API**

**`LensAPI` разработан для асинхронных операций. Вы должны использовать `async` и `await` при вызове его методов.**

#### Базовое использование API

Сначала импортируйте класс `LensAPI` и `asyncio`:

```python
import asyncio
from chrome_lens_py import LensAPI
```

#### Пример использования API

1. **Создание экземпляра API**:

   ```python
   api = LensAPI() # Или с конфигурацией, смотрите "Параметры конфигурации"
   ```

2. **Обработка изображения**:

   Вы можете обрабатывать изображения из различных источников: файловые пути, URL-адреса, объекты PIL Image и массивы NumPy.

   - **Получение всех данных из локального файла**:

     ```python
     import asyncio
     from chrome_lens_py import LensAPI

     async def main():
         api = LensAPI()
         result = await api.get_all_data('путь/к/изображению.jpg') # Используйте await!
         print(result)

     if __name__ == "__main__":
         asyncio.run(main())
     ```

   - **Получение всех данных по URL**:

     ```python
     import asyncio
     from chrome_lens_py import LensAPI

     async def main():
         api = LensAPI()
         result = await api.get_all_data('https://example.com/image.jpg') # Используйте await!
         print(result)

     if __name__ == "__main__":
         asyncio.run(main())
     ```

   - **Получение полного текста по умолчанию из объекта PIL Image**:

     ```python
     import asyncio
     from PIL import Image
     from chrome_lens_py import LensAPI

     async def main():
         api = LensAPI()
         image = Image.open('путь/к/изображению.jpg')
         result = await api.get_full_text(image) # Передайте объект PIL Image, используйте await!
         print(result)

     if __name__ == "__main__":
         asyncio.run(main())
     ```

   - **Получение сшитого текста с использованием умного метода из массива NumPy**:

     ```python
     import asyncio
     import numpy as np
     from PIL import Image # Pillow необходим для загрузки изображения в этом примере
     from chrome_lens_py import LensAPI

     async def main():
         api = LensAPI()
         image_np_array = np.array(Image.open('путь/к/изображению.jpg')) # Загрузите изображение как массив NumPy
         result = await api.get_stitched_text_smart(image_np_array) # Передайте массив NumPy, используйте await!
         print(result)

     if __name__ == "__main__":
         asyncio.run(main())
     ```

   - **Другие методы (full_text_sequential, get_text_with_coordinates и т.д.)**: Следуйте тому же шаблону, используя `await` перед вызовом методов API и убедившись, что ваш вызывающий код находится внутри `async` функции.

#### Параметры конфигурации

Вы можете настроить поведение `LensAPI`, передав словарь `config` и другие параметры при создании экземпляра класса. Это позволяет вам контролировать различные аспекты API, такие как заголовки, прокси, управление куки, отладку, время запроса и ограничение скорости.

Конструктор `LensAPI` принимает следующие параметры:

- **`config` (dict, optional)**: Словарь, содержащий параметры конфигурации (подробности смотрите ниже).
- **`sleep_time` (int, optional)**: Устанавливает задержку по умолчанию в миллисекундах между последовательными запросами API. По умолчанию `1000` (1 секунда). Может быть переопределено параметром `sleep_time` в `config`.
- **`logging_level` (int, optional)**: Устанавливает уровень логирования для API. Использует уровни модуля `logging` Python (например, `logging.DEBUG`, `logging.INFO`, `logging.WARNING`). По умолчанию `logging.WARNING`. Может быть переопределено параметром `debug` в `config`.
- **`rate_limit_rpm` (int, optional)**: Устанавливает максимальное количество запросов в минуту (RPM) для ограничения скорости. Значение должно быть от 1 до 50. Может быть переопределено параметром `rate_limiting` в `config`.

Следующие ключи могут быть использованы в словаре `config`:

- ~~**`header_type`**: выбирает набор заголовков, которые будут использоваться для запросов.~~ Временно убрано!
    - `'default'`: использует набор заголовков по умолчанию.
    - `'custom'`: использует собственный набор заголовков.
    - `'chrome'`: использует заголовки, имитирующие заголовки, отправляемые браузером Chrome.
    ```python
    api = LensAPI(config={'header_type': 'chrome'})
    ```

- **`proxy`**: указывает прокси-сервер для отправки запросов. Поддерживает прокси-серверы HTTP, HTTPS и SOCKS.
    ```python
    api = LensAPI(config={'proxy': 'socks5://127.0.0.1:2080'})
    ```

- **`cookies`**: управляет куки для сеанса. Может быть путем к файлу cookie формата Netscape, строкой cookie или словарем cookie.
    ```python
    api = LensAPI(config={'cookies': '/путь/к/cookie_file.txt'})
    ```
    ```python
    api = LensAPI(config={'cookies': '__Secure-ENID=...; NID=...'})
    ```
    ```python
    api = LensAPI(config={'cookies': {'__Secure-ENID': {'name': '...', 'value': '...', 'expires': ...}, 'NID ': {'имя': '...', 'значение': '...', 'истекает': ...}}})
    ```

- **`sleep_time`**: устанавливает задержку в миллисекундах между последовательными запросами API. Это особенно полезно при пакетной обработке, чтобы избежать перегрузки сервера. Переопределяет параметр `sleep_time` в конструкторе `LensAPI`.
    ```python
    api = LensAPI(config={'sleep_time': 500}) # Установите задержку 500 мс
    ```

- **`debug`**: Включает отладочное логирование.
    - `'info'`: Включает информационное логирование.
    - `'debug'`: Включает подробное отладочное логирование и сохраняет необработанные ответы API в `response_debug.txt`. Переопределяет параметр `logging_level` в конструкторе `LensAPI`.
    ```python
    api = LensAPI(config={'debug': 'debug'})
    ```

- **`debug_out`**:  указывает путь к файлу для сохранения необработанного ответа API для целей отладки, когда `debug` установлен в `'debug'`.
    ```python
    api = LensAPI(config={'debug_out': '/путь/к/response_debug.txt'})
    ```

- **`rate_limiting`**: Настраивает параметры ограничения скорости.
    - **`max_requests_per_minute`**: Устанавливает максимальное количество запросов в минуту (RPM). Значение должно быть от 1 до 50. Переопределяет параметры `rate_limit_rpm` в конструкторе `LensAPI` и `--rate-limit-rpm` в CLI, если не указано в командной строке.
    ```python
    api = LensAPI(config={'rate_limiting': {'max_requests_per_minute': 30}})
    ```


</details>

<details>
  <summary><b>Управление куки</b></summary>

Этот проект поддерживает управление куки через различные методы.

Для получения куки в формате Netscape вы можете использовать следующие расширения:

- Chrome (Chromium): [Cookie Editor](https://chromewebstore.google.com/detail/cookie-editor/hlkenndednhfkekhgcdicdfddnkalmdm)
- Firefox: [Cookie Editor](https://addons.mozilla.org/ru/firefox/addon/cookie-editor/)

1. **Загрузка куки из файла в формате Netscape**:

   * Вы можете загрузить куки из файла в формате Netscape, указав путь к файлу.

   **Программный API**:

   ```python
   config = {
       'cookies': '/путь/к/cookie_file.txt'
   }
   api = LensAPI(config=config)
   ```

   **CLI**:

   ```bash
   lens_scan путь/к/изображению.jpg all -c /путь/к/cookie_file.txt
   ```
2. **Передача куки напрямую в виде строки**:

   * Вы также можете передавать куки напрямую в виде строки через конфигурацию.

   **Программный API**:

   ```python
   config = {
       'cookies': '__Secure-ENID=17.SE=-dizH-; NID=511=---bcDwC4fo0--lgfi0n2-'
   }
   api = LensAPI(config=config)
   ```

   или

   ```python
   config = {
       'cookies': {
           '__Secure-ENID': {
               'name': '__Secure-ENID',
               'value': '',
               'expires': 1756858205,
           },
           'NID': {
               'name': 'NID',
               'value': '517=4.......',
               'expires': 1756858205,
           }
       }
   }
   api = LensAPI(config=config)
   ```

</details>

<details>
  <summary><b>Поддержка прокси</b></summary>

Вы можете выполнять запросы через прокси-сервер, используя API или CLI. Библиотека поддерживает HTTP, HTTPS и SOCKS4/5 прокси.

* **Установка прокси в API**:

  ```python
  config = {
      'proxy': 'socks5://127.0.0.1:2080'
  }
  api = LensAPI(config=config)
  ```
* **Установка прокси в CLI**:

  ```bash
  lens_scan путь/к/изображению.jpg all -p socks5://127.0.0.1:2080
  ```

</details>

<details>
  <summary><b>Методы программного API</b></summary>

**Важно: Асинхронные методы**

**Все методы класса `LensAPI` являются асинхронными и должны вызываться с `await`.**

- **`get_all_data(image_source, coordinate_format='percent')`**: Возвращает все доступные данные для данного источника изображения (путь к файлу, URL, объект PIL Image или массив NumPy).
    - `image_source`: Путь к файлу изображения, URL изображения, объект PIL Image или массив NumPy.
    - `coordinate_format` (str, optional): Формат вывода координат, либо `'percent'`, либо `'pixels'`. По умолчанию `'percent'`.
- **`get_full_text(image_source, coordinate_format='percent')`**: Возвращает только полный текст с источника изображения.
    - `image_source`: Путь к файлу изображения, URL изображения, объект PIL Image или массив NumPy.
    - `coordinate_format` (str, optional): Формат вывода координат, либо `'percent'`, либо `'pixels'`. По умолчанию `'percent'`.
- **`get_text_with_coordinates(image_source, coordinate_format='percent')`**: Возвращает текст вместе с его координатами в формате JSON с источника изображения.
    - `image_source`: Путь к файлу изображения, URL изображения, объект PIL Image или массив NumPy.
    - `coordinate_format` (str, optional): Формат вывода координат, либо `'percent'`, либо `'pixels'`. По умолчанию `'percent'`.
- **`get_stitched_text_smart(image_source, coordinate_format='percent')`**: Возвращает сшитый текст с использованием умного метода с источника изображения.
    - `image_source`: Путь к файлу изображения, URL изображения, объект PIL Image или массив NumPy.
    - `coordinate_format` (str, optional): Формат вывода координат, либо `'percent'`, либо `'pixels'`. По умолчанию `'percent'`.
- **`get_stitched_text_sequential(image_source, coordinate_format='percent')`**: Возвращает сшитый текст с использованием базового последовательного метода с источника изображения.
    - `image_source`: Путь к файлу изображения, URL изображения, объект PIL Image или массив NumPy.
    - `coordinate_format` (str, optional): Формат вывода координат, либо `'percent'`, либо `'pixels'`. По умолчанию `'percent'`.

</details>

<details>
  <summary><b>Работа с координатами</b></summary>

### **Работа с координатами**

В нашем проекте координаты используются для определения позиции, размера и вращения текста на изображении. Каждый текстовый регион описывается набором значений, которые помогают точно определить, где и как отображать текст. Вот как интерпретируются эти значения:

1. **Y координата**: Первое значение в массиве координат представляет вертикальное положение верхнего левого угла текстового региона на изображении. Значение выражается как доля от общей высоты изображения, где `0.0` соответствует верхнему краю, а `1.0` — нижнему.
2. **X координата**: Второе значение указывает горизонтальное положение верхнего левого угла текстового региона. Значение выражается как доля от общей ширины изображения, где `0.0` соответствует левому краю, а `1.0` — правому.
3. **Ширина**: Третье значение представляет ширину текстового региона как долю от общей ширины изображения. Это значение определяет, сколько горизонтального пространства займет текст.
4. **Высота**: Четвертое значение указывает высоту текстового региона как долю от общей высоты изображения.
5. **Пятый параметр**: В текущих данных этот параметр всегда равен нулю и, по-видимому, не используется. Возможно, он зарезервирован для будущего использования или специфических модификаций текста.
6. **Шестой параметр**: Задает угол вращения текстового региона в градусах. Положительные значения указывают на вращение по часовой стрелке, отрицательные — против часовой стрелки.

Координаты измеряются от верхнего левого угла изображения. Это означает, что `(0.0, 0.0)` соответствует самому верхнему левому углу изображения, а `(1.0, 1.0)` — самому нижнему правому.

#### Пример использования координат

```json
{
    "text": "Пример текста",
    "coordinates": [
        0.5,
        0.5,
        0.3,
        0.1,
        0,
        -45
    ]
}
```

В этом примере:

- `0.5` — Y координата (50% от высоты изображения, текст выровнен по центру вертикально).
- `0.5` — X координата (50% от ширины изображения, текст выровнен по центру горизонтально).
- `0.3` — ширина текстового региона (30% от ширины изображения).
- `0.1` — высота текстового региона (10% от высоты изображения).
- `0` — не используется, значение по умолчанию (возможно, зарезервировано для будущего использования).
- `-45` — угол поворота текста против часовой стрелки на 45 градусов.

Эти значения используются для точного размещения, масштабирования и отображения текста на изображении.

#### **Использование формата координат**

Вы можете выбрать формат вывода координат: в процентах или в пикселях. По умолчанию координаты выводятся в процентах, но вы можете переключиться на пиксели с помощью соответствующих настроек.

##### **В консоли**

При использовании командной строки вы можете указать формат координат с помощью флага `--coordinate-format`. Допустимые значения: `'percent'` или `'pixels'`.

**Примеры использования:**

- **Вывод координат в процентах (по умолчанию):**

  ```bash
  lens_scan image.jpg coordinates
  ```
- **Вывод координат в пикселях:**

  ```bash
  lens_scan image.jpg coordinates --coordinate-format=pixels
  ```

##### **В API**

При использовании программного API вы можете передать параметр `coordinate_format` в методы класса `LensAPI`. Допустимые значения: `'percent'` или `'pixels'`.

**Пример использования:**

```python
import asyncio
from chrome_lens_py import LensAPI

async def main():
    api = LensAPI()

    # Путь к изображению
    image_path = 'image.jpg'

    # Получение данных с координатами в пикселях
    result = await api.get_all_data(image_path, coordinate_format='pixels') # Используйте await!

    print(result)

if __name__ == "__main__":
    asyncio.run(main())
```

#### **Важно**

- При выборе формата `'pixels'` координаты будут рассчитаны относительно **исходных размеров** изображения, даже если изображение было уменьшено для обработки.
- Если формат не указан, координаты по умолчанию выводятся в процентах.
- При работе с координатами в пикселях убедитесь, что вы используете исходное изображение для корректного отображения текстовых регионов.

</details>

<details>
  <summary><b>Отладка и Логирование</b></summary>

При использовании инструмента командной строки `lens_scan` вы можете управлять уровнем логирования с помощью флага `--debug`. Доступны два уровня:

- `--debug=info`: Включает логирование информационных сообщений, которые содержат общую информацию о этапах обработки.
- `--debug=debug`: Включает подробные отладочные сообщения, включая детальный вывод и сохранение сырого ответа от API в файл `response_debug.txt` в текущей директории.

**Примеры использования:**

- Запуск с информационным логированием:

  ```bash
  lens_scan путь/к/изображению.jpg all --debug=info
  ```
- Запуск с подробным отладочным логированием:

  ```bash
  lens_scan путь/к/изображению.jpg all --debug=debug
  ```

При использовании `--debug=debug` библиотека сохранит сырой ответ от API в файл `response_debug.txt` в текущей рабочей директории. Это может быть полезно для глубокой отладки и понимания точного ответа от API.

#### Программная Отладка

При использовании API в ваших Python-скриптах вы можете управлять уровнем логирования, настраивая модуль `logging` и передавая параметр `logging_level` при создании экземпляра класса `LensAPI`, или установив `debug` в `config`.

**Пример использования:**

```python
import asyncio
import logging
from chrome_lens_py import LensAPI

async def main():
    # Настройка базового логирования в консоль (опционально, для общего логирования Python)
    logging.basicConfig(level=logging.DEBUG)

    # Создаем экземпляр API с нужным уровнем логирования
    api = LensAPI(logging_level=logging.DEBUG) # Или api = LensAPI(config={'debug': 'debug'})

    # Обрабатываем изображение
    result = await api.get_all_data('путь/к/изображению.jpg') # Используйте await!
    print(result)

if __name__ == "__main__":
    asyncio.run(main())
```

Параметр `logging_level` в конструкторе `LensAPI` (или `debug` в `config`) принимает уровни логирования из модуля `logging` Python, такие как `logging.INFO`, `logging.DEBUG`, `logging.WARNING` и т.д. Вы также можете использовать строковые значения `'info'` и `'debug'` в `config` для параметра `debug`.

Когда уровень логирования установлен на `logging.DEBUG` (или `debug: 'debug'`), библиотека будет выводить подробную отладочную информацию и сохранять сырой ответ от API в файл `response_debug.txt` в текущей директории.

Флаг `--debug-out` (или `debug_out` в `config`) позволит указать путь, где сохранить ответ от сервера, в случае уровня отладки `DEBUG`. По уполчанию он сохраняется, как описано выше, в папке откуда запущена консоль, то есть в `CWD`.

#### Примечания об Уровнях Логирования

- Уровень **INFO**: Предоставляет общую информацию о процессе, такую как отправка запросов и получение ответов.
- Уровень **DEBUG**: Предоставляет подробную информацию, полезную для отладки, включая внутреннее состояние и сохраненные ответы.


</details>

<details> <summary><b>Управление конфигурацией</b></summary>

### Приоритет конфигурации

При запуске CLI-инструмента `lens_scan` приложение определяет настройки на основе следующего приоритета (от самого высокого к самому низкому):

1. **Аргументы командной строки (CLI)**: Опции, указанные непосредственно при запуске команды, имеют наивысший приоритет.
2. **Переменные окружения**: Если настройка не указана в CLI, приложение проверит соответствующие переменные окружения.
3. **Файл конфигурации**: Если настройка не найдена в аргументах CLI или переменных окружения, приложение обратится к файлу конфигурации.
4. **Значения по умолчанию**: Если настройка не указана ни в одном из вышеперечисленных мест, используются значения по умолчанию.

### Файл конфигурации по умолчанию

* Файл конфигурации по умолчанию находится в директории конфигурации пользователя, которая зависит от операционной системы:
  * **Windows**: `C:\Users\<ВашеИмяПользователя>\.config\chrome-lens-py\config.json`
  * **Unix/Linux**: `/home/<ВашеИмяПользователя>/.config\chrome-lens-py\config.json`
  * **macOS**: `/Users/<ВашеИмяПользователя>/Library/Application Support/chrome-lens-py/config.json`

### Указание пользовательского файла конфигурации

* Вы можете указать пользовательский файл конфигурации с помощью флага `--config-file`:

  ```bash
  lens_scan --config-file путь/до/вашего/config.json <image_source> <data_type>
  ```
* Когда указан пользовательский файл конфигурации, он считается только для чтения и не будет изменен приложением.

### Настройки конфигурации

Файл конфигурации представляет собой JSON-файл, который может включать следующие настройки:

* **`proxy`**: Укажите прокси-сервер для маршрутизации запросов.

  ```json
  {
    "proxy": "socks5://username:password@proxy.example.com:1080"
  }
  ```
* **`cookies`**: Укажите cookies для использования в запросах. Это может быть путь к файлу cookies или строка cookies.

  ```json
  {
    "cookies": "путь/до/вашего/cookie_file.txt"
  }
  ```

  или

  ```json
  {
    "cookies": "__Secure-ENID=17.SE=-dizH-; NID=511=---bcDwC4fo0--lgfi0n2-"
  }
  ```
* **`coordinate_format`**: Установите формат вывода координат. Допустимые значения: `"percent"` или `"pixels"`.

  ```json
  {
    "coordinate_format": "pixels"
  }
  ```
* **`debug`**: Установите уровень логирования для CLI и API. Допустимые значения: `"info"` или `"debug"`.

  ```json
  {
    "debug": "debug"
  }
  ```

* **`debug_out`**:  указывает путь к файлу для сохранения необработанного ответа API для целей отладки, когда `debug` установлен в `'debug'`.

    ```json
    {
      "debug_out": "/путь/к/response_debug.txt"
    }
    ```

* **`data_type`**: Установите тип [выходных данных](#типы-данных) по умолчанию для CLI, если не указан в командной строке.

  ```json
  {
    "data_type": "all"
  }
  ```

* **`sleep_time`**: Устанавливает задержку по умолчанию в миллисекундах между последовательными запросами API, используемую в пакетной обработке и вызовах API, если не переопределена в конструкторе `LensAPI`.

    ```json
    {
      "sleep_time": 500
    }
    ```
* ~~**`header_type`**:  выбирает набор заголовков по умолчанию для использования в запросах, если не указано через CLI или конструктор API. Допустимые значения: `"default"`, `"custom"`, `"chrome"`.~~ Временно убрано!

    ```json
    {
      "header_type": "chrome"
    }
    ```

* **`rate_limiting`**: Настраивает параметры ограничения скорости.
    - **`max_requests_per_minute`**: Устанавливает максимальное количество запросов в минуту (RPM). Значение должно быть от 1 до 50. Переопределяет параметры `rate_limit_rpm` в конструкторе `LensAPI` и `--rate-limit-rpm` в CLI, если не указано в командной строке.

    ```json
    {
      "rate_limiting": {
        "max_requests_per_minute": 30
      }
    }
    ```


### Полный пример файла конфигурации

Вот пример файла конфигурации, который включает все возможные параметры конфигурации:

```json
{
  "proxy": "socks5://username:password@proxy.example.com:1080",
  "cookies": "путь/до/вашего/cookie_file.txt",
  "coordinate_format": "pixels",
  "debug": "debug",
  "debug_out": "/путь/к/response_debug.txt",
  "data_type": "all",
  "sleep_time": 500,
  "header_type": "chrome",
  "rate_limiting": {
    "max_requests_per_minute": 30
  }
}
```

### Обновление файла конфигурации

* Чтобы обновить файл конфигурации по умолчанию с новыми настройками из CLI, используйте флаг `-uc` или `--update-config`.

  ```bash
  lens_scan <image_source> <data_type> [опции] -uc
  ```
* **Примечание**: Файл конфигурации будет обновлен только в том случае, если это файл конфигурации по умолчанию (т.е. не указан через `--config-file`).
* Обновляются только определенные настройки:

  * **Настройки, которые могут быть обновлены**:

    * `coordinate_format`
    * `debug`
    * `data_type`
    * `sleep_time`
    * `header_type`
    * `rate_limiting.max_requests_per_minute`
  * **Настройки, которые **не** будут обновлены**:

    * `proxy`
    * `cookies`
    * `image_source`

* Это позволяет сохранять определенные настройки между запусками без изменения критических конфигураций, таких как прокси или cookies.

### Примеры использования

* **Обновление формата координат в файле конфигурации по умолчанию**:

  ```bash
  lens_scan путь/до/изображения.jpg all --coordinate-format=pixels -uc
  ```

  * Эта команда установит формат координат в пикселях для текущего запуска и обновит файл конфигурации по умолчанию, чтобы в будущих запусках также использовались пиксели как формат координат.
* **Использование прокси без обновления файла конфигурации**:

  ```bash
  lens_scan путь/до/изображения.jpg all -p socks5://127.0.0.1:2080
  ```

  * Настройка прокси будет использована для этого запуска, но не будет сохранена в файл конфигурации.
* **Указание пользовательского файла конфигурации (только для чтения)**:

  ```bash
  lens_scan --config-file путь/до/config.json путь/до/изображения.jpg all
  ```

  * Приложение будет использовать настройки из указанного файла конфигурации, но не будет изменять его, даже если используется флаг `-uc`.

### Переменные окружения

Вы также можете указывать настройки через переменные окружения:

* **`LENS_SCAN_PROXY`**: Установите прокси-сервер.

  ```bash
  export LENS_SCAN_PROXY="socks5://username:password@proxy.example.com:1080"
  ```
* **`LENS_SCAN_COOKIES`**: Предоставьте cookies.

  ```bash
  export LENS_SCAN_COOKIES="__Secure-ENID=17.SE=-dizH-; NID=511=---"
  ```
* **`LENS_SCAN_CONFIG_PATH`**: Укажите пользовательский файл конфигурации.

  ```bash
  export LENS_SCAN_CONFIG_PATH="путь/до/вашего/config.json"
  ```

</details>

<details>
<summary><b>Пакетная Обработка</b></summary>

### Пакетная обработка нескольких изображений

Этот проект поддерживает пакетную обработку изображений, когда вместо одного файла изображения указан путь к каталогу. Приложение обработает все файлы изображений в указанном каталоге.

#### Использование CLI

Чтобы выполнить пакетную обработку через командную строку, просто укажите путь к каталогу, содержащему изображения, вместо одного файла изображения.

```bash
lens_scan путь/к/каталогу <data_type> [опции]
```

* **`путь/к/каталогу`**: Путь к каталогу, содержащему файлы изображений.
* **`<data_type>`**: Тип данных для извлечения (например, `all`, `full_text_default` и т.д.).
* **`[опции]`**: Дополнительные опции, такие как `--out-txt`, `--sleep-time` и т.д.

**Пример:**

```bash
lens_scan /путь/к/изображениям all --out-txt=per_file --sleep-time=500
```

#### Опции вывода с помощью `--out-txt`

Флаг `--out-txt` позволяет контролировать, как сохраняется вывод при обработке нескольких изображений:

* **`--out-txt=per_file`**: Сохраняет каждый результат в отдельный текстовый файл на основе имени изображения в том же каталоге.
* **`--out-txt=имя_файла.txt`**: Сохраняет все результаты в один текстовый файл с указанным именем в том же каталоге.
* **Без флага `--out-txt`**: По умолчанию все результаты сохраняются в файл с именем `output.txt` в том же каталоге.

**Примеры:**

1. **Вывод в отдельные файлы для каждого изображения:**

    ```bash
    lens_scan /путь/к/изображениям all --out-txt=per_file
    ```

    Эта команда обрабатывает все изображения в `/путь/к/изображениям` и сохраняет каждый результат в отдельный текстовый файл с именем изображения (например, `image1.txt`, `image2.txt`).

2. **Вывод всех результатов в один файл:**

    ```bash
    lens_scan /путь/к/изображениям all --out-txt=результаты.txt
    ```

    Эта команда обрабатывает все изображения и сохраняет все результаты в `результаты.txt` в том же каталоге.

3. **Вывод по умолчанию (output.txt):**

    ```bash
    lens_scan /путь/к/изображениям all
    ```

    Без указания `--out-txt` результаты сохраняются в `output.txt` в том же каталоге.


#### Формат вывода

При выводе в один файл (поведение по умолчанию или при указании имени файла с помощью `--out-txt`) формат файла вывода следующий:

```plaintext
#имя_файла1.jpg
Извлеченный текст из имя_файла1.jpg

#имя_файла2.png
Извлеченный текст из имя_файла2.png

...
```

Извлеченный текст из каждого изображения предваряется символом `#`, за которым следует имя файла, и текст сохраняет исходное форматирование, включая символы новой строки.

#### Время задержки между запросами

Чтобы избежать перегрузки API и соблюдения политики ограничения скорости, библиотека вводит задержку между обработкой каждого изображения. По умолчанию время задержки установлено на 1000 миллисекунд (1 секунда). Вы можете настроить эту задержку с помощью флага `-st` или `--sleep-time`, указав время в миллисекундах.

**Пример:**

```bash
lens_scan /путь/к/изображениям all --sleep-time 500
```

Эта команда устанавливает время задержки в 500 миллисекунд между обработкой каждого изображения.

#### Программное использование API

Вы также можете выполнить пакетную обработку с помощью Python API, предоставив путь к каталогу методам. **Обратите внимание, что пакетная обработка через методы API также является асинхронной и требует `await`.**

**Пример:**

```python
import asyncio
from chrome_lens_py import LensAPI

async def main():
    api = LensAPI(sleep_time=500)  # Установите время задержки в 500 миллисекунд

    # Путь к каталогу, содержащему изображения
    directory_path = '/путь/к/изображениям'

    # Обработайте каталог для извлечения полного текста из каждого изображения
    results = await api.get_full_text(directory_path) # Используйте await!

    # Переберите результаты
    for filename, text in results.items():
        if 'error' in text:
            print(f"Ошибка при обработке {filename}: {text['error']}")
        else:
            print(f"# {filename}")
            print(text)
            print()

if __name__ == "__main__":
    asyncio.run(main())
```


#### Примечания:

* **Поддерживаемые файлы изображений**: Обрабатываются только файлы изображений с поддерживаемыми MIME-типами. Неформатированные файлы или неподдерживаемые форматы будут проигнорированы.
* **Настройка времени задержки**: Время задержки между запросами можно настроить в соответствии с вашими потребностями, но будьте осторожны при его уменьшении, чтобы избежать ограничения по скорости со стороны API.
* **Ограничение скорости (Rate Limiting)**: Помните об ограничении скорости, особенно при обработке больших пакетов изображений. Используйте опцию CLI `--rate-limit-rpm` или параметр `rate_limit_rpm` в конструкторе `LensAPI` для контроля скорости запросов.
* **Обработка ошибок**: Если при обработке изображения возникает ошибка, сообщение об ошибке будет сохранено в результатах под именем этого файла.
* **Файлы вывода**: При использовании `--out-txt=per_file` текстовые файлы вывода будут сохранены в том же каталоге, что и изображения, с тем же базовым именем файла и расширением `.txt`.

</details>

## Структура проекта

```plain
/chrome-lens-api-py
│
├── /src
│   ├── /chrome_lens_py
│   │   ├── __init__.py           # Инициализация пакета
│   │   ├── constants.py          # Константы, используемые в проекте
│   │   ├── utils.py              # Вспомогательные функции
│   │   ├── image_processing.py   # Модуль обработки изображений
│   │   ├── request_handler.py    # Модуль обработки запросов API
│   │   ├── text_processing.py    # Модуль обработки текста
│   │   ├── lens_api.py           # Интерфейс API для использования в других скриптах
│   │   └── main.py               # Точка входа CLI инструмента
│
├── setup.py                      # Установка проекта
├── README.md                     # Описание проекта и руководство по использованию
└── requirements.txt              # Зависимости проекта
```

## Благодарности

Особая благодарность [dimdenGD](https://github.com/dimdenGD) за метод извлечения текста, использованный в этом проекте. Вы можете ознакомиться с его работой в репозитории [chrome-lens-ocr](https://github.com/dimdenGD/chrome-lens-ocr). Этот проект вдохновлен их подходом к использованию функциональности OCR Google Lens.

## TODO

- [X] Добавить "scan by url"
- [X] Добавить вывод в пикселях
- [X] Поддержка ввода из PIL Image и NumPy массивов
- [X] Реализовать Rate Limiting
- [ ] Перенести все методы из [chrome-lens-ocr](https://github.com/dimdenGD/chrome-lens-ocr)
  - cookie!?
- [X] Сделать код чуть более читабельным...
- [ ] Еще кое-что очень, очень важное...

## Лицензия

Этот проект лицензирован на условиях лицензии MIT. Подробнее см. в файле [LICENSE](LICENSE).

## Отказ от ответственности

Этот проект предназначен только для образовательных целей. Использование функциональности OCR Google Lens должно соответствовать условиям использования Google. Автор этого проекта не несет ответственности за любое неправильное использование этого программного обеспечения или за любые последствия, возникающие из его использования. Пользователи несут полную ответственность за обеспечение того, что использование этого программного обеспечения соответствует всем применимым законам и нормативным актам.

## Автор

### Bropines  - [Почта](mailto:bropines@gmail.com) / [Telegram](https://t.me/bropines)

Спешал фор рускоговорящих. Да, ридми был написан GPT-шкой. Мне было ооооооочень лень его писать ручками :)